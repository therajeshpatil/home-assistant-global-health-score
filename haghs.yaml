# HAGHS - Home Assistant Global Health Score v1.2
# Naming Convention: Area: Object - Function

- sensor:
      - name: "System: HA - Global Health Score"
        unique_id: system_ha_global_health_score
        icon: mdi:shield-check
        unit_of_measurement: "%"
        state: >
          {# === CONFIGURATION: SET YOUR ENTITY IDs HERE === #}
          {% set cpu_id = 'sensor.processor_use' %}
          {% set ram_id = 'sensor.memory_use_percent' %}
          {% set disk_id = 'sensor.disk_use_percent_home' %}
          {# ============================================== #}

          {# 1. PILLAR: HARDWARE (40%) #}
          {% set cpu = states(cpu_id) | float(0) %}
          {% set ram = states(ram_id) | float(0) %}
          {% set disk = states(disk_id) | float(0) %}

          {% set cpu_score = ([0, (100 - (cpu * 0.2)), 100] | sort)[1] %}
          {% set ram_score = 100 if ram < 70 else ([0, (100 - (ram - 70) * 3.33), 100] | sort)[1] %}
          {% set disk_score = ([0, (100 - (disk * 1.25)), 100] | sort)[1] %}
          {% set hardware_final = (cpu_score + ram_score + disk_score) / 3 %}

          {# 2. PILLAR: APPLICATION (60%) #}
          {% set zombies = states.all 
            | selectattr('state', 'in', ['unavailable', 'unknown']) 
            | rejectattr('domain', 'in', ['button', 'scene', 'automation', 'device_tracker', 'group', 'input_button']) 
            | list %}
          
          {% set zombie_count = zombies | count %}
          {% set zombie_penalty = ([0, (zombie_count * 2), 20] | sort)[1] %}
          
          {# Safety Net: Backups & Updates #}
          {% set backup_stale = 30 if is_state('binary_sensor.backups_stale', 'on') else 0 %}
          {% set update_pending = 5 if states('sensor.home_assistant_versions') != states('sensor.current_version') else 0 %}
          
          {% set app_final = 100 - zombie_penalty - backup_stale - update_pending %}

          {# FINAL GLOBAL CALCULATION #}
          {{ ((hardware_final * 0.4) + (app_final * 0.6)) | round(0) }}

        attributes:
          zombie_entities: >
            {# This creates a comma-separated list of the actual problematic entities #}
            {% set zombies = states.all 
              | selectattr('state', 'in', ['unavailable', 'unknown']) 
              | rejectattr('domain', 'in', ['button', 'scene', 'automation', 'device_tracker', 'group', 'input_button']) 
              | map(attribute='entity_id') | list %}
            {{ zombies | join(', ') if zombies | count > 0 else 'None' }}
          
          recommendations: >
            {% set cpu = states('sensor.processor_use') | float(0) %}
            {% set disk = states('sensor.disk_use_percent_home') | float(0) %}
            {% set z_count = states.all 
              | selectattr('state', 'in', ['unavailable', 'unknown']) 
              | rejectattr('domain', 'in', ['button', 'scene', 'automation', 'device_tracker', 'group', 'input_button']) 
              | list | count %}
            
            {% set advice = [] %}
            {% if cpu > 80 %}{% set advice = advice + ["âš ï¸ High CPU: Check for rogue Add-ons."] %}{% endif %}
            {% if disk > 85 %}{% set advice = advice + ["âš ï¸ Disk Space: Purge database or old backups."] %}{% endif %}
            {% if z_count > 0 %}{% set advice = advice + ["âš ï¸ Registry: " ~ z_count ~ " zombie entities detected."] %}{% endif %}
            {% if is_state('binary_sensor.backups_stale', 'on') %}{% set advice = advice + ["ðŸš¨ Security: Stale backup detected!"] %}{% endif %}
            
            {{ advice | join('\n') if advice | count > 0 else "âœ… System Optimized." }}
            
